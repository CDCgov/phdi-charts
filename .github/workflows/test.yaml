---
name: Test
on:
    workflow_call:
    workflow_dispatch:
    pull_request:
        branches:
            - "**"
    push:
        branches:
            - main

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Install yamllint
              run: pip install yamllint

            - name: Lint YAML files
              run: yamllint -c yaml_lint_configuration.yaml .
    unittests:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v2
      
          - name: Setup kubectl
            uses: azure/setup-kubectl@v1
            with:
              version: 'v1.20.0'
      
          - name: Setup Helm
            uses: azure/setup-helm@v1
            with:
              version: 'v3.4.0'
      
          # - name: Configure kubeconfig
          #   env:
          #     KUBECONFIG_FILE: ${{ secrets.YOUR_KUBECONFIG_SECRET }}
          #   run: echo "$KUBECONFIG_FILE" > ~/.kube/config

          # Loop through each chart and run helm upgrade and helm test
          - name: Upgrade and Test All Charts
            run: |
              for chart in ./charts/*/; do
                chart_name=$(basename $chart)
                helm upgrade $chart_name $chart --install
                helm test $chart_name
              done
